# deployments/kubernetes/deployment.yaml
# OpenEAAP Kubernetes Deployment Configuration
# 定义 OpenEAAP 服务的完整部署资源清单

apiVersion: apps/v1
kind: Deployment
metadata:
  name: openeeap-server
  namespace: openeeap
  labels:
    app: openeeap
    component: server
    version: v1.0.0
  annotations:
    description: "OpenEAAP Enterprise AI Agent Platform Server"
    maintainer: "openeeap-team@example.com"
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: openeeap
      component: server
  template:
    metadata:
      labels:
        app: openeeap
        component: server
        version: v1.0.0
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    spec:
      # 服务账户配置
      serviceAccountName: openeeap-sa

      # 安全上下文
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      # 初始化容器 - 数据库迁移
      initContainers:
        - name: db-migration
          image: openeeap/server:v1.0.0
          command: ["/app/migrate"]
          args: ["up"]
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: openeeap-secrets
                  key: database-url
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "200m"

      # 主容器
      containers:
        - name: server
          image: openeeap/server:v1.0.0
          imagePullPolicy: IfNotPresent

          # 容器安全上下文
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
            capabilities:
              drop:
                - ALL

          # 端口配置
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: grpc
              containerPort: 9090
              protocol: TCP
            - name: metrics
              containerPort: 9091
              protocol: TCP

          # 环境变量配置
          env:
            # 应用配置
            - name: APP_ENV
              value: "production"
            - name: APP_PORT
              value: "8080"
            - name: GRPC_PORT
              value: "9090"
            - name: METRICS_PORT
              value: "9091"

            # 数据库配置
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: openeeap-secrets
                  key: database-url
            - name: DATABASE_MAX_OPEN_CONNS
              value: "25"
            - name: DATABASE_MAX_IDLE_CONNS
              value: "5"
            - name: DATABASE_CONN_MAX_LIFETIME
              value: "5m"

            # Redis 配置
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: openeeap-secrets
                  key: redis-url
            - name: REDIS_POOL_SIZE
              value: "10"
            - name: REDIS_MAX_RETRIES
              value: "3"

            # Milvus 配置
            - name: MILVUS_HOST
              valueFrom:
                configMapKeyRef:
                  name: openeeap-config
                  key: milvus-host
            - name: MILVUS_PORT
              valueFrom:
                configMapKeyRef:
                  name: openeeap-config
                  key: milvus-port
            - name: MILVUS_USERNAME
              valueFrom:
                secretKeyRef:
                  name: openeeap-secrets
                  key: milvus-username
            - name: MILVUS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: openeeap-secrets
                  key: milvus-password

            # MinIO 配置
            - name: MINIO_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: openeeap-config
                  key: minio-endpoint
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: openeeap-secrets
                  key: minio-access-key
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: openeeap-secrets
                  key: minio-secret-key
            - name: MINIO_BUCKET
              value: "openeeap-data"

            # Kafka 配置
            - name: KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: openeeap-config
                  key: kafka-brokers
            - name: KAFKA_CONSUMER_GROUP
              value: "openeeap-server"

            # vLLM 配置
            - name: VLLM_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: openeeap-config
                  key: vllm-endpoint
            - name: VLLM_TIMEOUT
              value: "300s"

            # 缓存配置
            - name: CACHE_L1_SIZE
              value: "1000"
            - name: CACHE_L1_TTL
              value: "5m"
            - name: CACHE_L2_TTL
              value: "1h"
            - name: CACHE_L3_SIMILARITY_THRESHOLD
              value: "0.95"

            # 可观测性配置
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: openeeap-config
                  key: otel-endpoint
            - name: OTEL_SERVICE_NAME
              value: "openeeap-server"
            - name: LOG_LEVEL
              value: "info"
            - name: LOG_FORMAT
              value: "json"

            # 治理配置
            - name: POLICY_ENFORCEMENT_ENABLED
              value: "true"
            - name: AUDIT_ENABLED
              value: "true"
            - name: PII_DETECTION_ENABLED
              value: "true"

          # 资源限制
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
              ephemeral-storage: "2Gi"
            limits:
              memory: "2Gi"
              cpu: "2000m"
              ephemeral-storage: "4Gi"

          # 存活探针 - 检查服务是否存活
          livenessProbe:
            httpGet:
              path: /health/live
              port: http
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 3

          # 就绪探针 - 检查服务是否就绪接收流量
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3

          # 启动探针 - 检查服务是否启动完成
          startupProbe:
            httpGet:
              path: /health/startup
              port: http
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 30

          # 卷挂载
          volumeMounts:
            - name: config
              mountPath: /app/configs
              readOnly: true
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /app/cache
            - name: logs
              mountPath: /app/logs

        # 边车容器 - 日志收集
        - name: log-collector
          image: fluent/fluent-bit:2.1
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"
          volumeMounts:
            - name: logs
              mountPath: /app/logs
              readOnly: true
            - name: fluent-bit-config
              mountPath: /fluent-bit/etc

      # 卷定义
      volumes:
        - name: config
          configMap:
            name: openeeap-config
            items:
              - key: production.yaml
                path: production.yaml
        - name: tmp
          emptyDir: {}
        - name: cache
          emptyDir:
            sizeLimit: 2Gi
        - name: logs
          emptyDir:
            sizeLimit: 1Gi
        - name: fluent-bit-config
          configMap:
            name: fluent-bit-config

      # 节点选择器 - 调度到特定节点
      nodeSelector:
        workload-type: compute-intensive

      # 亲和性配置 - Pod 反亲和性，避免单点故障
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - openeeap
                topologyKey: kubernetes.io/hostname

      # 容忍度配置 - 允许调度到有特定污点的节点
      tolerations:
        - key: "node.kubernetes.io/not-ready"
          operator: "Exists"
          effect: "NoExecute"
          tolerationSeconds: 300
        - key: "node.kubernetes.io/unreachable"
          operator: "Exists"
          effect: "NoExecute"
          tolerationSeconds: 300

      # DNS 配置
      dnsPolicy: ClusterFirst

      # 重启策略
      restartPolicy: Always

      # 终止宽限期
      terminationGracePeriodSeconds: 30

---
# Worker Deployment - 后台任务处理
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openeeap-worker
  namespace: openeeap
  labels:
    app: openeeap
    component: worker
    version: v1.0.0
spec:
  replicas: 2
  selector:
    matchLabels:
      app: openeeap
      component: worker
  template:
    metadata:
      labels:
        app: openeeap
        component: worker
        version: v1.0.0
    spec:
      serviceAccountName: openeeap-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000

      containers:
        - name: worker
          image: openeeap/worker:v1.0.0
          imagePullPolicy: IfNotPresent

          env:
            - name: WORKER_CONCURRENCY
              value: "10"
            - name: KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: openeeap-config
                  key: kafka-brokers
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: openeeap-secrets
                  key: database-url

          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "1000m"

          volumeMounts:
            - name: config
              mountPath: /app/configs
              readOnly: true
            - name: tmp
              mountPath: /tmp

      volumes:
        - name: config
          configMap:
            name: openeeap-config
        - name: tmp
          emptyDir: {}

      nodeSelector:
        workload-type: background-tasks

---
# GPU Inference Deployment - GPU 推理服务
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openeeap-inference-gpu
  namespace: openeeap
  labels:
    app: openeeap
    component: inference
    accelerator: gpu
    version: v1.0.0
spec:
  replicas: 2
  selector:
    matchLabels:
      app: openeeap
      component: inference
      accelerator: gpu
  template:
    metadata:
      labels:
        app: openeeap
        component: inference
        accelerator: gpu
        version: v1.0.0
    spec:
      serviceAccountName: openeeap-sa

      containers:
        - name: vllm
          image: vllm/vllm-openai:v0.5.0
          args:
            - "--model"
            - "/models/llama-2-7b"
            - "--tensor-parallel-size"
            - "1"
            - "--max-model-len"
            - "4096"
            - "--gpu-memory-utilization"
            - "0.9"

          ports:
            - name: http
              containerPort: 8000
              protocol: TCP

          resources:
            requests:
              nvidia.com/gpu: 1
              memory: "16Gi"
              cpu: "4"
            limits:
              nvidia.com/gpu: 1
              memory: "24Gi"
              cpu: "8"

          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 60
            periodSeconds: 30

          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10

          volumeMounts:
            - name: model-storage
              mountPath: /models
              readOnly: true
            - name: shm
              mountPath: /dev/shm

      volumes:
        - name: model-storage
          persistentVolumeClaim:
            claimName: openeeap-model-storage
        - name: shm
          emptyDir:
            medium: Memory
            sizeLimit: 8Gi

      nodeSelector:
        accelerator: nvidia-tesla-v100

      tolerations:
        - key: "nvidia.com/gpu"
          operator: "Exists"
          effect: "NoSchedule"

# Personal.AI order the ending
